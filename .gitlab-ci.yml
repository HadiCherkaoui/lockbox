image: 
  name: sonarsource/sonar-scanner-cli:11
  entrypoint: [""]

variables:
  SONAR_USER_HOME: "${CI_PROJECT_DIR}/.sonar"  # Defines the location of the analysis task cache
  GIT_DEPTH: "0"  # Tells git to fetch all the branches of the project, required by the analysis task
  DOCKER_TAG: "latest"

stages:
  - verify
  - release

.default-rules: &default_rules
  rules:
    - if: $CI_PIPELINE_SOURCE == 'merge_request_event'
    - if: $CI_COMMIT_BRANCH == 'master'
    - if: $CI_COMMIT_BRANCH == 'main'
    - if: $CI_COMMIT_BRANCH == 'develop'

tests:
  stage: verify
  image: rust:latest
  <<: *default_rules
  script:
    - rustup component add clippy rustfmt
    - cargo fmt --check
    - cargo check --locked --all
    - cargo clippy -- -D warnings
    - cargo test --all --locked

sonar:
  stage: verify
  image:
    name: sonarsource/sonar-scanner-cli:11
    entrypoint: [""]
  <<: *default_rules
  cache:
    policy: pull-push
    key: "sonar-cache-$CI_COMMIT_REF_SLUG"
    paths:
      - "${SONAR_USER_HOME}/cache"
      - sonar-scanner/
  script:
    - sonar-scanner -Dsonar.host.url="${SONAR_HOST_URL}"
  allow_failure: true

docker-build:
  stage: release
  image: docker:29
  services:
    - name: docker:28.0.4-dind
      alias: docker
      command: ["dockerd", "--host=tcp://0.0.0.0:2375", "--host=unix:///var/run/docker.sock", "--tls=false"]
  variables:
    DOCKER_HOST: tcp://docker:2375
    DOCKER_TLS_CERTDIR: ""
  needs:
    - job: tests
    - job: sonar
      optional: true
  <<: *default_rules
  before_script:
    - docker info
    - echo "$CI_REGISTRY_PASSWORD" | docker login -u "$CI_REGISTRY_USER" --password-stdin "$CI_REGISTRY"
  script:
    - docker build -t "$CI_REGISTRY_IMAGE:$DOCKER_TAG" -f Dockerfile .
    - docker push "$CI_REGISTRY_IMAGE:$DOCKER_TAG"