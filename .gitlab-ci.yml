image: 
  name: sonarsource/sonar-scanner-cli:11
  entrypoint: [""]

variables:
  SONAR_USER_HOME: "${CI_PROJECT_DIR}/.sonar"  # Defines the location of the analysis task cache
  GIT_DEPTH: "0"  # Tells git to fetch all the branches of the project, required by the analysis task

stages:
  - verify
  - release

.default-rules: &default_rules
  rules:
    - if: $CI_PIPELINE_SOURCE == 'merge_request_event'
    - if: $CI_COMMIT_BRANCH == 'master'
    - if: $CI_COMMIT_BRANCH == 'main'
    - if: $CI_COMMIT_BRANCH == 'develop'

tests:
  stage: verify
  image: rust:latest
  <<: *default_rules
  script:
    - rustup component add clippy rustfmt
    - cargo fmt --check
    - cargo check --locked --all
    - cargo clippy -- -D warnings
    - cargo test --all --locked

sonar:
  stage: verify
  image:
    name: sonarsource/sonar-scanner-cli:11
    entrypoint: [""]
  <<: *default_rules
  cache:
    policy: pull-push
    key: "sonar-cache-$CI_COMMIT_REF_SLUG"
    paths:
      - "${SONAR_USER_HOME}/cache"
      - sonar-scanner/
  script:
    - sonar-scanner -Dsonar.host.url="${SONAR_HOST_URL}"
  allow_failure: true

docker-build:
  stage: release
  image: docker:29
  services:
    - docker:29-dind
  needs:
    - job: tests
    - job: sonar
      optional: true
  <<: *default_rules
  script:
    - docker login -u "$CI_REGISTRY_USER" -p "$CI_REGISTRY_PASSWORD" "$CI_REGISTRY"
    - docker build -t "$CI_REGISTRY_IMAGE:${CI_COMMIT_SHA}" -f Dockerfile .
    - docker push "$CI_REGISTRY_IMAGE:${CI_COMMIT_SHA}"
    - |
      if [ "$CI_COMMIT_BRANCH" = "main" ] || [ "$CI_COMMIT_BRANCH" = "master" ]; then
        docker tag "$CI_REGISTRY_IMAGE:${CI_COMMIT_SHA}" "$CI_REGISTRY_IMAGE:latest"
        docker push "$CI_REGISTRY_IMAGE:latest"
      fi